<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>羊了个羊关卡编辑器</title>
    <style>
         * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            padding: 15px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            overflow: hidden;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            position: relative;
        }
        
        h1 {
            color: #4a6ee0;
            margin-bottom: 12px;
            font-size: 28px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .level-name-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .level-name-container label {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        
        .level-name-container input {
            padding: 8px 12px;
            border: 2px solid #4a6ee0;
            border-radius: 8px;
            font-size: 14px;
            width: 120px;
            text-align: center;
        }
        
        .editor-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .editor-container {
                flex-direction: row;
            }
            
            .tools-panel {
                width: 250px;
            }
        }
        
        .tools-panel {
            background: linear-gradient(to bottom, #f9f9f9, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .panel-section h3 {
            color: #4a6ee0;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        
        .panel-section h3::before {
            content: "•";
            margin-right: 8px;
            color: #6e8efb;
        }
        
        .block-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .block-item {
            width: 50px;
            height: 50px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .block-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.15);
        }
        
        .block-item.selected {
            border-color: #4a6ee0;
            box-shadow: 0 0 12px rgba(74, 110, 224, 0.6);
            transform: scale(1.05);
        }
        
        .block-item img {
            max-width: 80%;
            max-height: 80%;
        }
        
        .editor-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .editor-controls button {
            padding: 10px;
            background: linear-gradient(to right, #4a6ee0, #6e8efb);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 14px;
        }
        
        .editor-controls button:hover {
            background: linear-gradient(to right, #3a5ec0, #5d7ee0);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .editor-controls button:active {
            transform: translateY(0);
        }
        
        .layer-controls select {
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            background: #f0f0f0;
            border-radius: 12px;
            overflow: auto;
            height: 500px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.1);
        }
        
        #editor-canvas {
            position: relative;
            width: 100%;
            height: 100%;
            transform-origin: top left;
        }
        
        .grid-cell {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 1px dashed #ccc;
            background-color: rgba(255, 255, 255, 0.7);
        }
        
        .block {
            position: absolute;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 2;
        }
        
        .block:hover {
            transform: scale(1.1);
            z-index: 10;
            filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.3));
        }
        
        .block img {
            max-width: 90%;
            max-height: 90%;
        }
        
        .json-panel {
            width: 100%;
            margin-top: 20px;
            background: linear-gradient(to bottom, #f9f9f9, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .json-panel h3 {
            color: #4a6ee0;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .json-panel textarea {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .json-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }
        
        .json-buttons button {
            padding: 10px 15px;
            background: linear-gradient(to right, #4a6ee0, #6e8efb);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 14px;
            min-width: 120px;
        }
        
        .json-buttons button:hover {
            background: linear-gradient(to right, #3a5ec0, #5d7ee0);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .help-text {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(to bottom, #f9f9f9, #f0f0f0);
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.6;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .help-text p {
            margin-bottom: 8px;
        }
        
        .help-text strong {
            color: #4a6ee0;
        }
        
        .tutorial-link {
            color: #4a6ee0;
            cursor: pointer;
            text-decoration: underline;
            font-weight: bold;
        }
        
        .tutorial-link:hover {
            color: #3a5ec0;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .zoom-controls button {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            background: #4a6ee0;
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
            margin-top: 12px;
            padding: 8px 12px;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 13px;
        }
        
        .mode-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .mode-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4a6ee0;
        }
        
        .add-mode .mode-dot {
            background: #4CAF50;
        }
        
        .remove-mode .mode-dot {
            background: #F44336;
        }
        
        .mobile-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .mobile-toolbar button {
            padding: 10px 15px;
            background: linear-gradient(to right, #4a6ee0, #6e8efb);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        /* 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .modal-header h2 {
            color: #4a6ee0;
            margin: 0;
            font-size: 24px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .tools-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .tool-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .tool-item:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .tool-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .tool-info {
            flex: 1;
        }
        
        .tool-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .tool-desc {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .tool-download {
            background: linear-gradient(to right, #4a6ee0, #6e8efb);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .tool-download:hover {
            background: linear-gradient(to right, #3a5ec0, #5d7ee0);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        
        .ios-message {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .ios-message i {
            font-size: 48px;
            color: #4a6ee0;
            margin-bottom: 15px;
            display: block;
        }
        
        /* 视频教程样式 */
        .video-container {
            width: 100%;
            max-width: 560px;
            margin: 0 auto;
        }
        
        .video-container video {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .video-description {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
        
        @media (max-width: 767px) {
            .tools-panel {
                order: 2;
            }
            
            .canvas-container {
                order: 1;
            }
            
            .block-palette {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .block-item {
                width: 45px;
                height: 45px;
            }
            
            .editor-controls {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .editor-controls button {
                flex: 1;
                min-width: 120px;
            }
            
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            .tool-item {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            
            .tool-info {
                text-align: center;
            }
            
            .video-container {
                max-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .block-palette {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .editor-controls button {
                min-width: 100px;
                font-size: 12px;
            }
            
            .json-buttons button {
                min-width: 100px;
                font-size: 12px;
            }
            
            .canvas-container {
                height: 400px;
            }
            
            .tool-icon {
                width: 40px;
                height: 40px;
            }
            
            .tool-name {
                font-size: 14px;
            }
            
            .tool-desc {
                font-size: 12px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-puzzle-piece"></i> 羊了个羊关卡编辑器</h1>
            <p>可视化编辑关卡，支持导入和导出JSON数据</p>
            
            <div class="level-name-container">
                <label for="level-name">关卡名称:</label>
                <input type="number" id="level-name" value="90017" min="1" max="99999">
            </div>
        </header>
        
        <div class="mobile-toolbar">
            <button id="mobile-add-btn"><i class="fas fa-plus"></i> 添加</button>
            <button id="mobile-remove-btn"><i class="fas fa-trash"></i> 删除</button>
            <button id="mobile-clear-btn"><i class="fas fa-broom"></i> 清空</button>
        </div>
        
        <div class="editor-container">
            <div class="tools-panel">
                <div class="panel-section">
                    <h3>方块选择</h3>
                    <div class="block-palette" id="block-palette">
                        <!-- 方块选择器将由JS动态生成 -->
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3>编辑工具</h3>
                    <div class="editor-controls">
                        <button id="add-block-btn">
                            <i class="fas fa-plus"></i> 添加方块
                        </button>
                        <button id="remove-block-btn">
                            <i class="fas fa-trash"></i> 删除方块
                        </button>
                        <button id="clear-layer-btn">
                            <i class="fas fa-broom"></i> 清空当前层
                        </button>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3>层级控制</h3>
                    <select id="layer-select">
                        <!-- 层级选择将由JS动态生成 -->
                    </select>
                    <div class="editor-controls">
                        <button id="add-layer-btn">
                            <i class="fas fa-layer-group"></i> 添加新层
                        </button>
                        <button id="remove-layer-btn">
                            <i class="fas fa-minus-circle"></i> 删除当前层
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="canvas-container">
                <div id="editor-canvas">
                    <!-- 网格和方块将由JS动态生成 -->
                </div>
                
                <div class="zoom-controls">
                    <button id="zoom-out"><i class="fas fa-search-minus"></i></button>
                    <button id="zoom-reset"><i class="fas fa-sync"></i></button>
                    <button id="zoom-in"><i class="fas fa-search-plus"></i></button>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="mode-indicator add-mode" id="mode-indicator">
                <div class="mode-dot"></div>
                <span>当前模式: 添加方块</span>
            </div>
            <div>当前层: <span id="current-layer-display">1</span></div>
            <div>方块数量: <span id="block-count">0</span></div>
        </div>
        
        <div class="json-panel">
            <h3><i class="fas fa-code"></i> JSON 数据</h3>
            <textarea id="json-output" readonly></textarea>
            <div class="json-buttons">
                <button id="export-btn">
                    <i class="fas fa-file-export"></i> 保存JSON
                </button>
                <button id="import-btn">
                    <i class="fas fa-file-import"></i> 导入JSON
                </button>
                <button id="copy-btn">
                    <i class="fas fa-copy"></i> 复制到剪贴板
                </button>
                <button id="download-tools-btn">
                    <i class="fas fa-download"></i> 下载工具
                </button>
            </div>
        </div>
        
        <div class="help-text">
            <p><strong><i class="fas fa-info-circle"></i> 使用说明：</strong></p>
            <p>1. 从左侧选择方块类型，然后点击"添加方块"后在画布上点击放置方块</p>
            <p>2. 选择"删除方块"后点击画布上的方块可删除</p>
            <p>3. 使用层级控制切换不同层进行编辑</p>
            <p>4. 设置关卡名称（数字ID），然后导出JSON数据</p>
            <p>5. 使用缩放工具调整画布视图</p>
            <p>6. 编辑好关卡后应用至羊了个羊，<span class="tutorial-link" id="tutorial-link">点击查看教程</span></p>
        </div>


<div class="help-text">
            <p><strong><i class="fas fa-exclamation-circle"></i> 注意事项：</strong></p>
            <p>如果你想在游戏实现间隔一格的效果，那你得在编辑器里间隔两格（别问我为什么，我也修复不了）</p>
        </div>

<div class="help-text">
            <p><strong><i class="fas fa-tag"></i> 特别说明：</strong></p>
                    <p>1. 软件作者：马里奥顶蘑菇Mario</p>
            <p>2. 本软件完全免费，无广告，如果你是买来的你就被骗了！</p>
            <p>3. 可以随意转载分享本软件，但是不要以“分享这个软件”的名义去骗人！</p>
            <p>4. 本软件仅供娱乐使用，请勿用于商业用途！</p>
        </div>

    </div>

    <input type="file" id="import-file" style="display: none;" accept=".json">

    <!-- 下载工具弹窗 -->
    <div id="download-tools-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-download"></i> 下载工具</h2>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <div id="tools-container">
                <!-- 工具内容将由JS动态生成 -->
            </div>
        </div>
    </div>

<!-- 教程弹窗 -->
    <div id="tutorial-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-graduation-cap"></i> 应用教程</h2>
                <button class="close-btn" id="close-tutorial-modal">&times;</button>
            </div>
            <div id="tutorial-container">
                <!-- 教程内容将由JS动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 方块类型和图片映射
        const blockTypes = {
            1: { name: '小草', url: 'https://d6.qyshare.store/s/TBVWTxUNFQYPUgRWKFCVA50QYOGgIOUlQaKFCVA50wNVKFCVA50BoOVKFCVA50RVGlQGBlMODwKFCVA50PBgFTBRUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hhVVKFCVA50YFBFYEURpTKFCVA50FMHGgNTKFCVA50VYaDgVUUhoPVFMCUwIEUw8FVKFCVA50EZVV5ZFRsVVlQVDRUGKFCVA50lYKFCVA50BKFCVA50KFCVA50HBxoHVQ9UGgNUUg8aVQZWVhpRU1JSKFCVA50wMGKFCVA50lEPBwIVGxVZVlpSFQ0VBhlHWVKFCVA50VGxVUWFlDUllDY05HUhUNFV5aVlBSGEdZUBUbFVZTFQ0VBKFCVA50IEVgdTBVIaBKFCVA50UBVRoDBwJSGlUGUlIaKFCVA50KFCVA50KFCVA50FKFCVA50gYBKFCVA50wVRKFCVA50Q4BFUo=' },
            2: { name: '胡萝卜', url: 'https://d6.qyshare.store/s/TBVWTxUNFQ4HKFCVA50KFCVA50VSKFCVA50FYPGlJWUwMaKFCVA50w9WKFCVA50RoPBwUDGgYCBgMGVlYGBwUBDxUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgHBVFSUw4PUxpRBlICGgMHBgcaVlICVBoGDgcBKFCVA50VIDKFCVA50KFCVA50cKFCVA50BwEZVV5ZFRsVVlQVDRUPKFCVA50QEOKFCVA50wMHBRpRKFCVA50VQGGgMDDwKFCVA50aDwMPURpWBQQBVKFCVA50QGVlMHKFCVA50VYVGxVZVlpSFQ0VBRlHWVKFCVA50VGxVUWFlDUllDY05HUhUNFV5aVlBSGEdZUBUbFVZTFQ0VDwYFBgNSUwcaVVJSVBoDKFCVA50QKFCVA50HGg9RBg4aUVNUVgcPVgdWKFCVA501YCFUo=' },
            3: { name: '玉米', url: 'https://d6.qyshare.store/s/TBVWTxUNFQ9SKFCVA50wMOBKFCVA50cEGlVUDw8aKFCVA50w8EBhoPDwKFCVA50CGlYHKFCVA50QVVUQEHBlZTBxUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hhRVgFTBKFCVA50EGVRpWVVMCGgNSKFCVA50FQaDgJVKFCVA50BoPU1VTDg8BKFCVA50QKFCVA50KFCVA50DgEZVV5ZFRsVVlQVDRUBD1JTKFCVA50VIPBxoPVKFCVA50VVGgMBVFIaVQFTKFCVA50RpRBgUOKFCVA50wFUUgBVBFIVGxVZVlpSFQ0VBBlHWVKFCVA50VGxVUWFlDUllDY05HUhUNFV5aVlBSGEdZUBUbFVZTFQ0VVKFCVA50EDKFCVA50wZUKFCVA50QUaVVRVBxoDKFCVA50VQBGlZWUQMaDgUOKFCVA50gIHKFCVA50QcEUQ8KFCVA50FUo=' },
            4: { name: '木头', url: 'https://d6.qyshare.store/s/TBVWTxUNFQJRBlVSUgRRGgcFVgcaKFCVA50w4DKFCVA50xpVKFCVA50FEBGg5RVQZRKFCVA50KFCVA50KFCVA50EKFCVA50FICVBUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hhSVlQHVQ8OBBoBUwFUGgMHUVQaVlNSVhpTUwdVBVZVKFCVA50gNWDwYZVV5ZFRsVVlQVDRUBVQdVKFCVA50gdUDxoDBg8KFCVA50GgMOB1UaDwcOKFCVA50hoOVQYKFCVA50DgdRBwMKFCVA50KFCVA501IVGxVZVlpSFQ0VKFCVA50xlHWVKFCVA50VGxVUWFlDUllDY05HUhUNFV5aVlBSGEdZUBUbFVZTFQ0VDwVTBgcKFCVA50VQIaKFCVA501QBBBoDUlMDGg5TKFCVA50FMaKFCVA50VYHDlQPKFCVA50KFCVA50FWBKFCVA50EEFUo=' },
            5: { name: '叉子', url: 'https://d6.qyshare.store/s/TBVWTxUNFVMPUwYDBVEHGgQFBQYaKFCVA50w8CUhoPUlYFGg9VKFCVA50gNSKFCVA501VSDwVUDxUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgFUgRUVVZVVRpSKFCVA501YPGgMPBQYaVlZTBRoBUlRVBVQOKFCVA50FJTVQcZVV5ZFRsVVlQVDRUOKFCVA50KFCVA505SBQ8OKFCVA50RoEDwMGGgNTBwMaDwQPKFCVA50BpTKFCVA50g8DBw9TDw8KFCVA50VVEVGxVZVlpSFQ0VKFCVA50hlHWVKFCVA50VGxVUWFlDUllDY05HUhUNFV5aVlBSGEdZUBUbFVZTFQ0VUlMBKFCVA50gNSBFQaKFCVA50wEHVRoDDgYKFCVA50GlUPKFCVA50lMaKFCVA50gEHD1ZSUQECDlEPFUo=' },
            6: { name: '白菜', url: 'https://d6.qyshare.store/s/TBVWTxUNFQEOBKFCVA50EFBQKFCVA50PGgIGDwIaKFCVA50w5TBxoOBKFCVA50ZVGlUHKFCVA50FZTDlUOVKFCVA508GVRUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgEUQQDKFCVA50gJWBRoFKFCVA501YGGgMFDgEaDlVUVhoEVKFCVA50dUKFCVA50KFCVA50ZSKFCVA50gMKFCVA50BQUZVV5ZFRsVVlQVDRVVKFCVA50lMEBgYDDhoCVgZWGgNTUVMaVVMBUxoKFCVA50BKFCVA508FKFCVA50g8GKFCVA50VMKFCVA50VQMVGxVZVlpSFQ0VKFCVA50RlHWVKFCVA50VGxVUWFlDUllDY05HUhUNFV5aVlBSGEdZUBUbFVZTFQ0VKFCVA50gUOKFCVA50lQDKFCVA50KFCVA50YaVVICUxoDBKFCVA50FVGg9RBKFCVA50KFCVA50aBKFCVA50EPUlQCVQQBBgYOFUo=' },
            7: { name: '羊毛', url: 'https://d6.qyshare.store/s/TBVWTxUNFQMOKFCVA50wZVVQVTGgRWBQEaKFCVA501FUBxoPVKFCVA50VVGlYBVVYFVVNTVlUOKFCVA50RUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgBKFCVA50Q4FVVZWBRoOUQVUGgNRKFCVA50wKFCVA50aDg8FBBoGKFCVA50QMKFCVA50VKFCVA50YDBKFCVA50cBUVYZVV5ZFRsVVlQVDRUFBwQHUlQDUhoHKFCVA50FIHGgNRUlEaDg9VUhoCBg4DVgNVDgNVVQMVGxVZVlpSFQ0VKFCVA50BlHWVKFCVA50VGxVUWFlDUllDY05HUhUNFV5aVlBSGEdZUBUbFVZTFQ0VKFCVA50KFCVA504BKFCVA50g5VDgcaKFCVA50gMOBBoDKFCVA50KFCVA508FGg8DUVMaKFCVA50wUDBgQKFCVA50DwIFBKFCVA50ECFUo=' },
            8: { name: '刷子', url: 'https://d6.qyshare.store/s/TBVWTxUNFQKFCVA50PKFCVA50VEHBlFVGgFRB1IaKFCVA50wJWUhpVB1JUGlMCKFCVA50gIPUwNTVgdVUxUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgDBFJTUgVTBRoOVQYDGgMHKFCVA50QMaDlRRKFCVA50hoKFCVA50BlIDKFCVA50wEFKFCVA50wYHUlMZVV5ZFRsVVlQVDRUBKFCVA50KFCVA50YDKFCVA50KFCVA504BKFCVA50BoCBKFCVA50VTGgMBUQUaVlUPBxpRKFCVA50VEPDlFWD1IKFCVA50B1UVGxVZVlpSFQ0VDxlHWVKFCVA50VGxVUWFlDUllDY05HUhUNFV5aVlBSGEdZUBUbFVZTFQ0VKFCVA50KFCVA50KFCVA50CBlIFBg4aDg8EVhoDVQUPGlUEVVIaKFCVA501VRKFCVA50KFCVA50YFD1YPKFCVA50lIDFUo=' },
            9: { name: '剪刀', url: 'https://d6.qyshare.store/s/TBVWTxUNFQMDBQdWDlVWGgBVBw8aKFCVA50wIFKFCVA50RpWVg4OGgRTUQKFCVA50GBg8GKFCVA50KFCVA504EBRUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hhSUlQDDwcPURoBKFCVA501NTGgNSBVEaDwQGDxpTBQYPKFCVA50wFSU1YKFCVA50BVIZVV5ZFRsVVlQVDRVUDwNTUwQFKFCVA50hpTBlYDGgNRBg4aVVQHKFCVA50RpVKFCVA50VJSKFCVA50gBWKFCVA50FYOBKFCVA50EVGxVZVlpSFQ0VDhlHWVKFCVA50VGxVUWFlDUllDY05HUhUNFV5aVlBSGEdZUBUbFVZTFQ0VUw8CBKFCVA50IOUw4aKFCVA50KFCVA50KFCVA50KFCVA50UxoDBwJTGg4GUlEaVg8FUwKFCVA50FKFCVA50wKFCVA50CU1ZTFUo=' },
            10: { name: '奶瓶', url: 'https://d6.qyshare.store/s/TBVWTxUNFQKFCVA50CUlZVDw5VGlMPBVEaKFCVA50wEEVRpVBwRRGlRWVgJUKFCVA50gUGUQYFUxUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgHVg5WKFCVA50lYGBRpSKFCVA50FMFGgMGBKFCVA50IaVlMGKFCVA50BoCBFIFDwQEUlFVUwKFCVA50ZVV5ZFRsVVlQVDRUEVlRSUVUDVRoHKFCVA50VUEGgMGDgIaVlUFUxpRKFCVA50KFCVA50JRVVRSDgKFCVA50BVgQVGxVZVlpSFQ0VBgcZR1lQFRsVVFhZQ1JZQ2NOR1IVDRVeWlZQUhhHWVKFCVA50VGxVWUxUNFQ8KFCVA50DgUGVQFTGlFTUQEaKFCVA501EGURpVKFCVA50FECGgNTVFRWUwQHKFCVA50g8PKFCVA50BVK' },
            11: { name: '水桶', url: 'https://d6.qyshare.store/s/TBVWTxUNFQQEKFCVA501QHBVIHGgYKFCVA50BKFCVA50MaKFCVA50wBUKFCVA50xpVUQRSGlQGKFCVA50VVSUQIOBlRWUxUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hhWBwYFBwNWVBpTDg8OGgMBBlUaVQQEKFCVA50BoPBQRUVKFCVA508GUVZVBwIZVV5ZFRsVVlQVDRVVBwKFCVA50FBFFUKFCVA50BpRKFCVA50KFCVA50NRGgMFVKFCVA504aVlJUVhoGUg4HVKFCVA50YDVlIKFCVA50KFCVA50KFCVA50EVGxVZVlpSFQ0VBgYZR1lQFRsVVFhZQ1JZQ2NOR1IVDRVeWlZQUhhHWVKFCVA50VGxVWUxUNFQMEKFCVA50VYOKFCVA501JWGgdRKFCVA50QMaKFCVA50wYBUhpWU1FWGlQFUVZVKFCVA50KFCVA509TVKFCVA505UBxVK' },
            12: { name: '手套', url: 'https://d6.qyshare.store/s/TBVWTxUNFVZRKFCVA50lMFUVRUGlZWKFCVA50QcaKFCVA501IDBRoPUQQFGgcEKFCVA50lMHBVVRDwMBDxUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgPKFCVA50QRRVFECVBoKFCVA50KFCVA50gQBGgMGKFCVA50gEaVlVUKFCVA50RoKFCVA50D1FTBVEKFCVA50UgMFVQ4ZVV5ZFRsVVlQVDRUBVQBWBQBSBBoFDwBWGgMHUg8aD1QPBRpSVQFRKFCVA50FEDBgJSUlYVGxVZVlpSFQ0VBgUZR1lQFRsVVFhZQ1JZQ2NOR1IVDRVeWlZQUhhHWVKFCVA50VGxVWUxUNFQZUKFCVA50wMCBQ5UGlFSKFCVA50Q8aKFCVA501QOVhpWBgUDGgYHUwIODwBRUlIPUhVK' },
            13: { name: '铃铛', url: 'https://d6.qyshare.store/s/TBVWTxUNFQ4KFCVA50KFCVA50lNUBQQGGgUPKFCVA50KFCVA504aKFCVA50wcGBhoPKFCVA50QRUGg4DVKFCVA50YBKFCVA50QdUDlNVKFCVA50hUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgGBgMDVQcPBhpVBKFCVA50RUGgMEDw8aDw8DKFCVA50RpRBwcDVlEGKFCVA50KFCVA50EEDgIZVV5ZFRsVVlQVDRVRBKFCVA50JRBFYKFCVA50VBpTKFCVA50Q5RGgMFKFCVA50VYaDlUEBBoCBlMFUgVTBgYEBQYVGxVZVlpSFQ0VBgQZR1lQFRsVVFhZQ1JZQ2NOR1IVDRVeWlZQUhhHWVKFCVA50VGxVWUxUNFQ9TVKFCVA508GBVECGgKFCVA50OBQQaKFCVA501EHBhpVVFEEGlYHBVUDDlIFVFIPKFCVA50RVK' },
            14: { name: '火', url: 'https://d6.qyshare.store/s/TBVWTxUNFQ4BBVIDKFCVA50gZVGgdTUgIaKFCVA501YDDxpVVlUDGgZTUgMKFCVA50KFCVA50FRVUQYGURUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgFKFCVA50FUBVFIBBBoGUwNUGgMEU1UaVgKFCVA50CUhoKFCVA50UVEEDwZTDw9TDlQZVV5ZFRsVVlQVDRVTVgJVBQMOUxoDKFCVA50gcPGgMDVlEaDgNUKFCVA50hpTB1IBUQdUDgRTBVMVGxVZVlpSFQ0VBgMZR1lQFRsVVFhZQ1JZQ2NOR1IVDRVeWlZQUhhHWVKFCVA50VGxVWUxUNFVVTBlYEBwRRGgIDKFCVA50KFCVA50IaKFCVA50wKFCVA50CURpWKFCVA50FVRGgKFCVA50CVgNVVVUBBg5RKFCVA50RVK' },
            15: { name: '毛线', url: 'https://d6.qyshare.store/s/TBVWTxUNFQYDBlRSUQ5TGlYKFCVA50BgMaKFCVA50wQPUxoOKFCVA50KFCVA50BTGgYODg4OKFCVA50wcEU1YEVhUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgDVlFRBwMFBBoHVgZVGgMBBKFCVA50YaVgcHBxpRUwQBDgJRBFFRBKFCVA50UZVV5ZFRsVVlQVDRUCVQEDBVIHURoCUwEOGgNVUlYaDgFUKFCVA50RpWKFCVA50QRSVlUKFCVA50BwRUKFCVA50KFCVA50cVGxVZVlpSFQ0VBgIZR1lQFRsVVFhZQ1JZQ2NOR1IVDRVeWlZQUhhHWVKFCVA50VGxVWUxUNFVFVDg8KFCVA50DgZVGgIHDgUaKFCVA501VVBRpVVlVWGlZWBg4EB1EPUQNUURVK' },
            16: { name: '稻子', url: 'https://d6.qyshare.store/s/TBVWTxUNFVRRKFCVA50VYCBgMDGlZWKFCVA50g4aKFCVA501RSBRoOVgcCGgUFBwZVBwEFKFCVA50lEPKFCVA50xUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hhSU1FTDgQOVRoEDwYEGgMFKFCVA50KFCVA50QaVQZVBxoDDlEFBFFTKFCVA50QMKFCVA50UgUZVV5ZFRsVVlQVDRUCUQ4EBFEGBhoGKFCVA50wFSGgMHVKFCVA50UaVgVRDxoCBgQGBwBTKFCVA50KFCVA50KFCVA50OKFCVA501IVGxVZVlpSFQ0VBgEZR1lQFRsVVFhZQ1JZQ2NOR1IVDRVeWlZQUhhHWVKFCVA50VGxVWUxUNFVEDKFCVA50w8FKFCVA50QBWGlRRKFCVA50QMaKFCVA50wKFCVA50EURoPKFCVA50Q9VGgNTKFCVA50lFUKFCVA50lEKFCVA50BQcDUhVK' }
        };

        // 工具数据
        const toolsData = [
            {
                icon: 'https://d6.qyshare.store/s/TBVWTxUNFQQHDgcEU1VVGlZTKFCVA50KFCVA504aKFCVA50wQHBBoOVQFTGlZTDgJSBQZSVKFCVA50BSKFCVA50RUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgBBQMBKFCVA50FFSUxpSVgRSGgMCKFCVA50QMaDwEBDhoHBVYDBKFCVA50KFCVA50PD1QBUVEZVV5ZFRsVVlQVDRVSKFCVA50QQCDgQKFCVA50URpWUQJWGgMPVgKFCVA50aVgKFCVA50HBBpUDwECBQ5VVKFCVA50JVBgEVGxVZVlpSFQ0V3qyKFCVA500KOC0Z-W0byo0q6fGUdZUBUbFVRYWUNSWUNjTkdSFQ0VXlpWUFIYR1lQFRsVVlMVDRVRKFCVA50QUOUwKFCVA50EKFCVA50xpRBFECGgMPKFCVA50QMaDw5TUhoEBlRWVVMCBwYCKFCVA50KFCVA50KFCVA50VSg==',
                name: '雷电模拟器',
                description: '安卓模拟器，在电脑上玩安卓游戏~',
                downloadUrl: 'https://pan.xunlei.com/s/VO_-QYklLhNouKY2K8YuDPC2A1?pwd=fsmw#',
                platforms: ['windows']
            },
            {
                icon: 'https://d6.qyshare.store/s/TBVWTxUNFVYOKFCVA501IHBFMKFCVA50Gg4HBQMaKFCVA50wdSKFCVA50RpWDgMEGlEEVQQHKFCVA50lYKFCVA50KFCVA50lMEURUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hgDKFCVA50QMOKFCVA50w8BVBoPUwUKFCVA50GgNUBwQaVQVVDhoBUVQHUQNWVKFCVA50UOKFCVA50KFCVA508ZVV5ZFRsVVlQVDRUCBg8HUlICKFCVA50hoFUw8FGgMDBVEaDgEDKFCVA50hpUUwUGBg8GUw5TKFCVA50QUVGxVZVlpSFQ0VWkPQmZbQp7HSrp8ZR1lQFRsVVFhZQ1JZQ2NOR1IVDRVeWlZQUhhHWVKFCVA50VGxVWUxUNFVIDVgKFCVA50CUQMKFCVA50GgUBKFCVA50g4aKFCVA50wBVDxoOBwEKFCVA50Gg8BU1YKFCVA50U1YGUQYGDxVK',
                name: 'MT管理器',
                description: '文件管理器，如果你安装过就不用再安装了。',
                downloadUrl: 'https://pan.xunlei.com/s/VO_-R4RVcUpoFsiCoiUwpFDVA1?pwd=9kys#',
                platforms: ['windows', 'android']
            },
            {
                icon: 'https://d6.qyshare.store/s/TBVWTxUNFQ5RVVZRDwQKFCVA50GlVSVFUaKFCVA50w4OKFCVA50BpWUwBRGgIKFCVA50U1IEBw9RKFCVA50KFCVA50IEUxUbFVhERH9YREMVDRVYREQZRk5CWRlYRVKFCVA50VGxVYRER8Uk4VDRVCR1tYVlMYBQcFKFCVA50hgGBxgHKFCVA50hhTUwMKFCVA50Bw4CKFCVA50xoHKFCVA50KFCVA504GGgMCBw8aDgEFBhpVBVEKFCVA50UVJWVKFCVA50IOKFCVA50gKFCVA50ZVV5ZFRsVVlQVDRUFUQZUBg4PUhoGKFCVA50gUFGgMCVVIaVlQBDhoFBQJSKFCVA50lRRDg9TKFCVA50QMVGxVZVlpSFQ0V0Im9042x04-d0Im9GV1HUBUbFVRYWUNSWUNjTkdSFQ0VXlpWUFIYXUdSUBUbFVZTFQ0VVlMBDgECVgQaUlQHBxoDKFCVA50KFCVA508EGg5VVQEaDlIHKFCVA50VYDBKFCVA50MOKFCVA50w5RFUo=',
                name: '羊了个羊-自定义关卡版',
                description: '可以游玩你在编辑器里编辑的关卡',
                downloadUrl: 'https://pan.xunlei.com/s/VO_5Y6yeMK7pslJZ0bd0xVUaA1?pwd=3h9a#',
                platforms: ['windows', 'android']
            }
        ];

  // 教程视频数据
        const tutorialVideos = {
            windows: 'https://wwwv.qyshare.com/api/share/download?token=xycoru&fileId=71036&hostId=1',
            android: 'https://wwwv.qyshare.com/api/share/download?token=m08fhu&fileId=71031&hostId=1'
        };

        // 编辑器状态
        let editorState = {
            currentBlockType: 1,
            currentLayer: 1,
            mode: 'add',
            blocks: {},
            gridSize: { x: 56, y: 64 },
            cellSize: 40,
            zoomLevel: 1,
            isMobile: window.innerWidth < 768
        };

        // 检测操作系统
        function detectOS() {
            const userAgent = navigator.userAgent;
            if (/android/i.test(userAgent)) {
                return 'android';
            } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                return 'ios';
            } else {
                return 'windows';
            }
        }

        // 显示下载工具弹窗
        function showDownloadTools() {
            const os = detectOS();
            const modal = document.getElementById('download-tools-modal');
            const toolsContainer = document.getElementById('tools-container');
            
            toolsContainer.innerHTML = '';
            
            if (os === 'ios') {
                toolsContainer.innerHTML = `
                    <div class="ios-message">
                        <i class="fas fa-ban"></i>
                        <h3>抱歉，暂不支持苹果端</h3>
                        <p>当前工具暂不支持iOS系统，请使用Windows或Android设备</p>
                    </div>
                `;
            } else {
                const availableTools = toolsData.filter(tool => 
                    tool.platforms.includes(os)
                );
                
                if (availableTools.length > 0) {
                    availableTools.forEach(tool => {
                        const toolElement = document.createElement('div');
                        toolElement.className = 'tool-item';
                        toolElement.innerHTML = `
                            <img src="${tool.icon}" alt="${tool.name}" class="tool-icon">
                            <div class="tool-info">
                                <div class="tool-name">${tool.name}</div>
                                <div class="tool-desc">${tool.description}</div>
                                <a href="${tool.downloadUrl}" target="_blank" class="tool-download">
                                    <i class="fas fa-download"></i> 立即下载
                                </a>
                            </div>
                        `;
                        toolsContainer.appendChild(toolElement);
                    });
                } else {
                    toolsContainer.innerHTML = `
                        <div class="ios-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>暂无可用工具</h3>
                            <p>当前系统暂无可用工具</p>
                        </div>
                    `;
                }
            }
            
            modal.style.display = 'flex';
        }
 // 显示教程弹窗
        function showTutorial() {
            const os = detectOS();
            const modal = document.getElementById('tutorial-modal');
            const tutorialContainer = document.getElementById('tutorial-container');
            
            tutorialContainer.innerHTML = '';
            
            if (os === 'ios') {
                tutorialContainer.innerHTML = `
                    <div class="ios-message">
                        <i class="fas fa-ban"></i>
                        <h3>抱歉，暂不支持苹果端</h3>
                        <p>iOS系统暂不支持自定义关卡功能，请使用Windows或Android设备</p>
                    </div>
                `;
            } else {
                const videoUrl = tutorialVideos[os];
                tutorialContainer.innerHTML = `
                    <div class="video-container">
                        <video controls autoplay>
                            <source src="${videoUrl}" type="video/mp4">
                            您的浏览器不支持视频播放。
                        </video>
                        <div class="video-description">
                            <p>${os === 'windows' ? 'Windows端' : 'Android端'}应用教程视频</p>
                        </div>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }
        // 初始化编辑器
        function initEditor() {
            // 初始化空的关卡数据
            for (let i = 1; i <= 20; i++) {
                editorState.blocks[i] = [];
            }
            
            // 创建方块选择器
            createBlockPalette();
            
            // 初始化层级选择
            initLayerSelector();
            
            // 绘制网格
            drawGrid();
            
            // 绑定事件
            bindEvents();
            
            // 更新JSON显示
            updateJsonOutput();
            
            // 更新状态显示
            updateStatusBar();
            
            // 移动端适配
            if (editorState.isMobile) {
                document.getElementById('mobile-add-btn').addEventListener('click', () => {
                    editorState.mode = 'add';
                    updateModeIndicator();
                });
                
                document.getElementById('mobile-remove-btn').addEventListener('click', () => {
                    editorState.mode = 'remove';
                    updateModeIndicator();
                });
                
                document.getElementById('mobile-clear-btn').addEventListener('click', () => {
                    if (confirm('确定要清空当前层吗？')) {
                        editorState.blocks[editorState.currentLayer] = [];
                        renderBlocks();
                        updateJsonOutput();
                    }
                });
            }
        }

        // 创建方块选择器
        function createBlockPalette() {
            const palette = document.getElementById('block-palette');
            palette.innerHTML = '';
            
            for (const [type, data] of Object.entries(blockTypes)) {
                const item = document.createElement('div');
                item.className = 'block-item';
                item.dataset.type = type;
                item.title = data.name;
                
                const img = document.createElement('img');
                img.src = data.url;
                img.alt = data.name;
                
                item.appendChild(img);
                palette.appendChild(item);
                
                // 默认选择第一个
                if (parseInt(type) === editorState.currentBlockType) {
                    item.classList.add('selected');
                }
                
                // 点击选择方块类型
                item.addEventListener('click', () => {
                    document.querySelectorAll('.block-item').forEach(el => {
                        el.classList.remove('selected');
                    });
                    item.classList.add('selected');
                    editorState.currentBlockType = parseInt(type);
                });
            }
        }

        // 初始化层级选择
        function initLayerSelector() {
            const selector = document.getElementById('layer-select');
            selector.innerHTML = '';
            
            for (let i = 1; i <= 20; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `第 ${i} 层`;
                if (i === editorState.currentLayer) {
                    option.selected = true;
                }
                selector.appendChild(option);
            }
            
            selector.addEventListener('change', () => {
                editorState.currentLayer = parseInt(selector.value);
                renderBlocks();
                updateStatusBar();
            });
        }

        // 绘制网格
        function drawGrid() {
            const canvas = document.getElementById('editor-canvas');
            canvas.innerHTML = '';
            
            // 设置画布大小
            const scaledCellSize = editorState.cellSize * editorState.zoomLevel;
            canvas.style.width = `${editorState.gridSize.x * scaledCellSize / 4}px`;
            canvas.style.height = `${editorState.gridSize.y * scaledCellSize / 4}px`;
            
            // 创建网格单元格
            for (let x = 0; x < editorState.gridSize.x; x += 4) {
                for (let y = 0; y < editorState.gridSize.y; y += 4) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.style.left = `${x * scaledCellSize / 4}px`;
                    cell.style.top = `${y * scaledCellSize / 4}px`;
                    cell.style.width = `${scaledCellSize}px`;
                    cell.style.height = `${scaledCellSize}px`;
                    canvas.appendChild(cell);
                }
            }
            
            // 重新渲染方块
            renderBlocks();
        }

        // 渲染方块
        function renderBlocks() {
            // 先清除所有方块
            document.querySelectorAll('.block').forEach(el => el.remove());
            
            const canvas = document.getElementById('editor-canvas');
            const currentLayer = editorState.currentLayer;
            const scaledCellSize = editorState.cellSize * editorState.zoomLevel;
            
            // 渲染当前层的方块
            if (editorState.blocks[currentLayer]) {
                editorState.blocks[currentLayer].forEach(block => {
                    const blockEl = createBlockElement(block, scaledCellSize);
                    canvas.appendChild(blockEl);
                });
            }
            
            // 半透明显示其他层的方块
            for (const layer in editorState.blocks) {
                if (parseInt(layer) !== currentLayer) {
                    editorState.blocks[layer].forEach(block => {
                        const blockEl = createBlockElement(block, scaledCellSize);
                        blockEl.style.opacity = '0.3';
                        canvas.appendChild(blockEl);
                    });
                }
            }
            
            // 更新状态栏
            updateStatusBar();
        }

        // 创建方块元素
        function createBlockElement(block, scaledCellSize) {
            const blockEl = document.createElement('div');
            blockEl.className = 'block';
            blockEl.dataset.id = block.id;
            blockEl.dataset.layer = block.layerNum;
            
            // 计算位置 (坐标除以4以适应网格)
            blockEl.style.left = `${block.rolNum * scaledCellSize / 4}px`;
            blockEl.style.top = `${block.rowNum * scaledCellSize / 4}px`;
            blockEl.style.width = `${scaledCellSize}px`;
            blockEl.style.height = `${scaledCellSize}px`;
            
            const img = document.createElement('img');
            // 确保使用正确的方块类型图片
            const blockType = block.moldType || block.type || 1;
            img.src = blockTypes[blockType]?.url || blockTypes[1].url;
            img.alt = blockTypes[blockType]?.name || '未知方块';
            
            blockEl.appendChild(img);
            return blockEl;
        }

        // 绑定事件
        function bindEvents() {
            const canvas = document.getElementById('editor-canvas');
            
            // 画布点击事件
            canvas.addEventListener('click', (e) => {
                if (e.target.classList.contains('grid-cell') || e.target === canvas) {
                    // 计算点击的网格坐标
                    const rect = canvas.getBoundingClientRect();
                    const scaleFactor = 4 / (editorState.cellSize * editorState.zoomLevel);
                    const x = Math.round((e.clientX - rect.left) * scaleFactor);
                    const y = Math.round((e.clientY - rect.top) * scaleFactor);
                    
                    if (editorState.mode === 'add') {
                        addBlock(x, y);
                    }
                } else if (e.target.classList.contains('block') || 
                          e.target.parentElement.classList.contains('block')) {
                    if (editorState.mode === 'remove') {
                        const blockEl = e.target.classList.contains('block') ? 
                            e.target : e.target.parentElement;
                        removeBlock(blockEl.dataset.id);
                    }
                }
            });
            
            // 触摸事件支持
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    const scaleFactor = 4 / (editorState.cellSize * editorState.zoomLevel);
                    const x = Math.round((touch.clientX - rect.left) * scaleFactor);
                    const y = Math.round((touch.clientY - rect.top) * scaleFactor);
                    
                    if (editorState.mode === 'add') {
                        addBlock(x, y);
                        e.preventDefault();
                    }
                }
            });
            
            // 添加方块按钮
            document.getElementById('add-block-btn').addEventListener('click', () => {
                editorState.mode = 'add';
                updateModeIndicator();
            });
            
            // 删除方块按钮
            document.getElementById('remove-block-btn').addEventListener('click', () => {
                editorState.mode = 'remove';
                updateModeIndicator();
            });
            
            // 清空当前层按钮
            document.getElementById('clear-layer-btn').addEventListener('click', () => {
                if (confirm('确定要清空当前层吗？')) {
                    editorState.blocks[editorState.currentLayer] = [];
                    renderBlocks();
                    updateJsonOutput();
                }
            });
            
            // 添加新层按钮
            document.getElementById('add-layer-btn').addEventListener('click', () => {
                const newLayer = Object.keys(editorState.blocks).length + 1;
                if (newLayer <= 20) {
                    editorState.blocks[newLayer] = [];
                    initLayerSelector();
                    document.getElementById('layer-select').value = newLayer;
                    editorState.currentLayer = newLayer;
                    renderBlocks();
                    updateJsonOutput();
                } else {
                    alert('最多只能有20层');
                }
            });
            
            // 删除当前层按钮
            document.getElementById('remove-layer-btn').addEventListener('click', () => {
                if (Object.keys(editorState.blocks).length <= 1) {
                    alert('至少需要保留一层');
                    return;
                }
                
                if (confirm('确定要删除当前层吗？')) {
                    delete editorState.blocks[editorState.currentLayer];
                    
                    // 选择另一层
                    const layers = Object.keys(editorState.blocks);
                    editorState.currentLayer = parseInt(layers[0]);
                    
                    initLayerSelector();
                    renderBlocks();
                    updateJsonOutput();
                }
            });
            
            // 导出JSON按钮
            document.getElementById('export-btn').addEventListener('click', () => {
                updateJsonOutput();
            });
            
            // 导入JSON按钮
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('import-file').click();
            });
            
            // 文件选择事件
            document.getElementById('import-file').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const jsonData = JSON.parse(event.target.result);
                            importLevelData(jsonData);
                        } catch (error) {
                            alert('导入失败：无效的JSON格式');
                            console.error(error);
                        }
                    };
                    reader.readAsText(file);
                }
            });
            
            // 复制JSON按钮
            document.getElementById('copy-btn').addEventListener('click', () => {
                const textarea = document.getElementById('json-output');
                textarea.select();
                document.execCommand('copy');
                alert('已复制到剪贴板');
            });
            
                    // 下载工具按钮
            document.getElementById('download-tools-btn').addEventListener('click', showDownloadTools);
            
            // 教程链接
            document.getElementById('tutorial-link').addEventListener('click', showTutorial);
            
            // 关闭弹窗按钮
            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('download-tools-modal').style.display = 'none';
            });
            
            document.getElementById('close-tutorial-modal').addEventListener('click', () => {
                document.getElementById('tutorial-modal').style.display = 'none';
            });
            
            // 点击弹窗外部关闭
            document.getElementById('download-tools-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('download-tools-modal')) {
                    document.getElementById('download-tools-modal').style.display = 'none';
                }
            });
            
            document.getElementById('tutorial-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('tutorial-modal')) {
                    document.getElementById('tutorial-modal').style.display = 'none';
                }
            });
            
            // 缩放控制
            document.getElementById('zoom-in').addEventListener('click', () => {
                editorState.zoomLevel = Math.min(2, editorState.zoomLevel + 0.1);
                drawGrid();
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                editorState.zoomLevel = Math.max(0.5, editorState.zoomLevel - 0.1);
                drawGrid();
            });
            
            document.getElementById('zoom-reset').addEventListener('click', () => {
                editorState.zoomLevel = 1;
                drawGrid();
            });
            
            // 关卡名称变化
            document.getElementById('level-name').addEventListener('change', () => {
                updateJsonOutput();
            });
            
            // 窗口大小变化时检测是否为移动端
            window.addEventListener('resize', () => {
                editorState.isMobile = window.innerWidth < 768;
            });
        }

        // 更新模式指示器
        function updateModeIndicator() {
            const indicator = document.getElementById('mode-indicator');
            indicator.className = 'mode-indicator ' + editorState.mode + '-mode';
            indicator.querySelector('span').textContent = 
                '当前模式: ' + (editorState.mode === 'add' ? '添加方块' : '删除方块');
        }

        // 更新状态栏
        function updateStatusBar() {
            document.getElementById('current-layer-display').textContent = editorState.currentLayer;
            
            // 计算总方块数
            let totalBlocks = 0;
            for (const layer in editorState.blocks) {
                totalBlocks += editorState.blocks[layer].length;
            }
            document.getElementById('block-count').textContent = totalBlocks;
        }

        // 添加方块
        function addBlock(x, y) {
            const layer = editorState.currentLayer;
            const blockId = `${layer}-${x}-${y}`;
            
            // 检查是否已存在相同位置的方块
            const existingIndex = editorState.blocks[layer].findIndex(
                block => block.rolNum === x && block.rowNum === y
            );
            
            if (existingIndex !== -1) {
                // 替换现有方块
                editorState.blocks[layer][existingIndex] = {
                    id: blockId,
                    type: 0,
                    rolNum: x,
                    rowNum: y,
                    layerNum: layer,
                    moldType: editorState.currentBlockType,
                    blockNode: null
                };
            } else {
                // 添加新方块
                editorState.blocks[layer].push({
                    id: blockId,
                    type: 0,
                    rolNum: x,
                    rowNum: y,
                    layerNum: layer,
                    moldType: editorState.currentBlockType,
                    blockNode: null
                });
            }
            
            renderBlocks();
            updateJsonOutput();
        }

        // 删除方块
        function removeBlock(blockId) {
            const [layer, x, y] = blockId.split('-').map(Number);
            
            editorState.blocks[layer] = editorState.blocks[layer].filter(
                block => !(block.rolNum === x && block.rowNum === y)
            );
            
            renderBlocks();
            updateJsonOutput();
        }

        // 更新JSON输出
        function updateJsonOutput() {
            // 获取关卡名称
            const levelName = parseInt(document.getElementById('level-name').value) || 90017;
            
            // 构建levelData
            const levelData = {};
            for (const layer in editorState.blocks) {
                if (editorState.blocks[layer].length > 0) {
                    levelData[layer] = editorState.blocks[layer];
                }
            }
            
            // 构建blockTypeData (统计每种类型的数量)
            const blockTypeData = {};
            for (let i = 1; i <= 16; i++) {
                blockTypeData[i] = 0;
            }
            
            for (const layer in editorState.blocks) {
                editorState.blocks[layer].forEach(block => {
                    const blockType = block.moldType || block.type || 1;
                    if (blockType in blockTypeData) {
                        blockTypeData[blockType]++;
                    }
                });
            }
            
            // 构建完整的关卡数据
            const levelJson = {
                widthNum: 8,
                heightNum: 10,
                levelKey: levelName,
                blockTypeData: blockTypeData,
                levelData: levelData
            };
            
            // 构建最终输出
            const outputData = {
                err_code: "0",
                err_msg: "OK",
                data: {
                    id: "62ce3ffb3dd1931da84a84f2",
                    map_id: levelName,
                    updated_at: new Date().toISOString(),
                    map_data: JSON.stringify(levelJson),
                    created_at: "2022-07-13T03:46:03.137Z"
                }
            };
            
            document.getElementById('json-output').value = JSON.stringify(outputData, null, 2);
        }

        // 导入关卡数据
        function importLevelData(jsonData) {
            try {
                // 解析map_data字符串
                const mapData = JSON.parse(jsonData.data.map_data);
                
                // 设置关卡名称
                document.getElementById('level-name').value = jsonData.data.map_id;
                
                // 重置编辑器状态
                editorState.blocks = {};
                
                // 导入层级数据
                for (const layer in mapData.levelData) {
                    // 确保正确解析每个方块的类型
                    editorState.blocks[layer] = mapData.levelData[layer].map(block => {
                        // 确保moldType是数字类型
                        if (typeof block.moldType === 'string') {
                            block.moldType = parseInt(block.moldType);
                        }
                        return block;
                    });
                }
                
                // 更新UI
                initLayerSelector();
                renderBlocks();
                updateJsonOutput();
                
                alert('导入成功！');
            } catch (error) {
                alert('导入失败：数据格式不正确');
                console.error(error);
            }
        }

        // 初始化编辑器
        window.addEventListener('load', initEditor);
    </script>
</body>
</html>